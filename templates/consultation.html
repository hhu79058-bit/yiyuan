<!DOCTYPE html>
<html>
<head>
    <title>è¯Šç–—å®¤ - {{ patient.name }}</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; background-color: #f5f7fa; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h2 { border-bottom: 2px solid #409EFF; padding-bottom: 10px; color: #333; }

        /* ç—…äººä¿¡æ¯æ¡ */
        .patient-info { background: #ecf5ff; padding: 15px; border-radius: 5px; color: #409EFF; margin-bottom: 20px; font-weight: bold; }

        /* è¡¨å•æ ·å¼ */
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #555; }
        textarea { width: 100%; height: 80px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }

        /* è¯å“è¡¨æ ¼ */
        .med-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .med-table th { background: #f0f2f5; text-align: left; padding: 10px; }
        .med-table td { padding: 8px; border-bottom: 1px solid #eee; }
        .med-select { width: 100%; padding: 8px; }
        .input-qty { width: 80px; padding: 8px; }

        .btn-add { background: #67C23A; color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 4px; }
        .btn-remove { background: #F56C6C; color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 4px; }

        .btn-submit { width: 100%; padding: 15px; background: #409EFF; color: white; border: none; font-size: 18px; border-radius: 5px; cursor: pointer; margin-top: 30px; }
        .btn-submit:hover { background: #66b1ff; }
    </style>

    <script>
        // ç®€å•çš„JSï¼šç‚¹å‡»æŒ‰é’®æ·»åŠ ä¸€è¡Œè¯å“è¾“å…¥æ¡†
        function addMedicineRow() {
            var table = document.getElementById("medTableBody");
            var row = table.insertRow(-1);

            // 1. è¯å“é€‰æ‹©ä¸‹æ‹‰æ¡†
            var cell1 = row.insertCell(0);
            var selectHTML = '<select name="med_id[]" class="med-select" required>';
            selectHTML += '<option value="">-- è¯·é€‰æ‹©è¯å“ --</option>';
            // è¿™é‡Œåˆ©ç”¨åç«¯ä¼ æ¥çš„æ•°æ®ç”Ÿæˆé€‰é¡¹
            {% for m in medicines %}
            selectHTML += '<option value="{{ m.med_id }}">{{ m.med_name }} (ï¿¥{{ m.price }} | åº“å­˜:{{ m.stock }})</option>';
            {% endfor %}
            selectHTML += '</select>';
            cell1.innerHTML = selectHTML;

            // 2. æ•°é‡è¾“å…¥æ¡†
            var cell2 = row.insertCell(1);
            cell2.innerHTML = '<input type="number" name="quantity[]" class="input-qty" min="1" value="1" required>';

            // 3. ç”¨æ³•è¾“å…¥æ¡†
            var cell3 = row.insertCell(2);
            cell3.innerHTML = '<input type="text" name="usage[]" placeholder="å¦‚ï¼šæ¯æ—¥3æ¬¡" class="med-select" required>';

            // 4. åˆ é™¤æŒ‰é’®
            var cell4 = row.insertCell(3);
            cell4.innerHTML = '<button type="button" class="btn-remove" onclick="removeRow(this)">åˆ é™¤</button>';
        }

        function removeRow(btn) {
            var row = btn.parentNode.parentNode;
            row.parentNode.removeChild(row);
        }
    </script>
</head>
<body>

<div class="container">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2>ğŸ©º è¯Šç–—å®¤</h2>
        <div>
            <a href="/doctor_dashboard" style="margin-right:12px; color:#409eff;">å·¥ä½œå°</a>
            <a href="/registration/manage" style="margin-right:12px; color:#409eff;">æŒ‚å·ç®¡ç†</a>
            <a href="/pharmacy" style="margin-right:12px; color:#409eff;">è¯æˆ¿ç®¡ç†</a>
            <a href="/cashier" style="margin-right:12px; color:#409eff;">æ”¶é“¶å°</a>
            <a href="/logout" style="color:#f56c6c;">é€€å‡º</a>
        </div>
    </div>

    <div class="patient-info">
        å½“å‰æ‚£è€…ï¼š{{ patient.name }} | æ€§åˆ«ï¼š{{ patient.gender }} | å¹´é¾„ï¼š{{ patient.age }}å²
        {% if patient.allergy %}
        <span style="color:red; margin-left:20px;">âš ï¸ è¿‡æ•å²ï¼š{{ patient.allergy }}</span>
        {% endif %}
    </div>

    <form method="POST" action="/submit_consultation">
        <input type="hidden" name="reg_id" value="{{ patient.reg_id }}">

        <div class="form-group">
            <label>1. æ‚£è€…ä¸»è¯‰ (Main Complaint)</label>
            <textarea name="main_complaint" placeholder="æ‚£è€…å“ªé‡Œä¸èˆ’æœï¼ŸæŒç»­äº†å¤šä¹…ï¼Ÿ" required></textarea>
        </div>

        <div class="form-group">
            <label>2. è¯Šæ–­ç»“æœ (Diagnosis)</label>
            <textarea name="diagnosis" placeholder="åˆæ­¥è¯Šæ–­ç»“è®º" required></textarea>
        </div>

        <div class="form-group">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <label style="margin:0;">3. å¼€å…·å¤„æ–¹ (Prescription)</label>
                <button type="button" class="btn-add" onclick="addMedicineRow()">+ æ·»åŠ è¯å“</button>
            </div>

            <table class="med-table">
                <thead>
                    <tr>
                        <th width="40%">è¯å“åç§°</th>
                        <th width="15%">æ•°é‡</th>
                        <th width="30%">ç”¨æ³•ç”¨é‡</th>
                        <th width="15%">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="medTableBody">
                    <tr>
                        <td>
                            <select name="med_id[]" class="med-select" required>
                                <option value="">-- è¯·é€‰æ‹©è¯å“ --</option>
                                {% for m in medicines %}
                                <option value="{{ m.med_id }}">{{ m.med_name }} (ï¿¥{{ m.price }} | åº“å­˜:{{ m.stock }})</option>
                                {% endfor %}
                            </select>
                        </td>
                        <td><input type="number" name="quantity[]" class="input-qty" min="1" value="1" required></td>
                        <td><input type="text" name="usage[]" placeholder="å¦‚ï¼šæ¯æ—¥3æ¬¡" class="med-select" required></td>
                        <td></td>
                    </tr>
                </tbody>
            </table>
        </div>

        <button type="submit" class="btn-submit">âœ… å®Œæˆè¯Šç–— (æäº¤ç—…å†ä¸å¤„æ–¹)</button>
    </form>
</div>

</body>
</html>
