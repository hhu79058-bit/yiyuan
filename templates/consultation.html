{% extends "base.html" %}
{% block title %}诊疗室 - {{ patient.name }}{% endblock %}

{% block extra_head %}
    <style>
        .patient-strip{display:flex;flex-wrap:wrap;gap:10px;align-items:center;padding:12px 14px;border-radius:14px;border:1px solid var(--border);background:rgba(47,125,246,.06)}
        .patient-strip strong{font-weight:900}
        .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:#fff}
        .med-actions{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-top:10px}
        .input-qty{max-width:120px}
    </style>
    <script>
        function addMedicineRow() {
            var table = document.getElementById("medTableBody");
            var row = table.insertRow(-1);

            var cell1 = row.insertCell(0);
            var selectHTML = '<select name="med_id[]" required>';
            selectHTML += '<option value="">-- 请选择药品 --</option>';
            {% for m in medicines %}
            selectHTML += '<option value="{{ m.med_id }}">{{ m.med_name }} (￥{{ m.price }} | 库存:{{ m.stock }})</option>';
            {% endfor %}
            selectHTML += '</select>';
            cell1.innerHTML = selectHTML;

            var cell2 = row.insertCell(1);
            cell2.innerHTML = '<input type="number" name="quantity[]" class="input-qty" min="1" value="1" required>';

            var cell3 = row.insertCell(2);
            cell3.innerHTML = '<input type="text" name="usage[]" placeholder="如：每日3次" required>';

            var cell4 = row.insertCell(3);
            cell4.innerHTML = '<button type="button" class="btn btn--danger btn--sm" onclick="removeRow(this)">删除</button>';
        }

        function removeRow(btn) {
            var row = btn.parentNode.parentNode;
            row.parentNode.removeChild(row);
        }
    </script>
{% endblock %}

{% block content %}
    <div class="card">
        <div class="page-title">
            <div>
                <h2>诊疗室</h2>
                <div class="subtitle">填写病历与处方，系统将校验库存后提交</div>
            </div>
            <a class="btn btn--ghost" href="{{ url_for('doctor.dashboard') }}">返回工作台</a>
        </div>

        <div class="patient-strip">
            <div class="pill"><strong>患者</strong>：{{ patient.name }}</div>
            <div class="pill"><strong>性别</strong>：{{ patient.gender }}</div>
            <div class="pill"><strong>年龄</strong>：{{ patient.age }}岁</div>
            {% if patient.allergy %}
                <div class="pill"><span class="badge badge--danger">过敏史</span> {{ patient.allergy }}</div>
            {% endif %}
            {% if patient.past_illness %}
                <div class="pill"><span class="badge badge--warning">既往病史</span> {{ patient.past_illness }}</div>
            {% endif %}
        </div>

        <form method="POST" action="{{ url_for('doctor.submit_consultation') }}">
            <input type="hidden" name="reg_id" value="{{ patient.reg_id }}">

            <label>患者主诉</label>
            <textarea name="main_complaint" placeholder="患者哪里不舒服？持续了多久？" required></textarea>

            <label>诊断结果</label>
            <textarea name="diagnosis" placeholder="初步诊断结论" required></textarea>

            <div class="med-actions">
                <div>
                    <h3 style="margin:0;">处方</h3>
                    <div class="subtitle">选择药品、数量与用法用量</div>
                </div>
                <button type="button" class="btn btn--ghost" onclick="addMedicineRow()">+ 添加药品</button>
            </div>

            <div class="table-wrap" style="margin-top:10px;">
                <table class="table">
                    <thead>
                    <tr>
                        <th width="40%">药品名称</th>
                        <th width="15%">数量</th>
                        <th width="30%">用法用量</th>
                        <th width="15%">操作</th>
                    </tr>
                    </thead>
                    <tbody id="medTableBody">
                    <tr>
                        <td>
                            <select name="med_id[]" required>
                                <option value="">-- 请选择药品 --</option>
                                {% for m in medicines %}
                                    <option value="{{ m.med_id }}">{{ m.med_name }} (￥{{ m.price }} | 库存:{{ m.stock }})</option>
                                {% endfor %}
                            </select>
                        </td>
                        <td><input type="number" name="quantity[]" class="input-qty" min="1" value="1" required></td>
                        <td><input type="text" name="usage[]" placeholder="如：每日3次" required></td>
                        <td></td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <div style="margin-top:14px; display:flex; justify-content:flex-end;">
                <button type="submit" class="btn btn--primary">完成诊疗并提交</button>
            </div>
        </form>
    </div>
{% endblock %}
