<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>挂号管理</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f5f7fa; margin: 0; padding: 20px; }
        .layout { max-width: 1200px; margin: 0 auto; }
        h1 { margin: 0 0 10px 0; }
        .flex { display: flex; gap: 16px; }
        .card { background: #fff; border-radius: 10px; padding: 18px; box-shadow: 0 6px 18px rgba(0,0,0,0.06); margin-bottom: 16px; }
        label { font-weight: 600; color: #444; display: block; margin: 8px 0 4px; }
        input, select { width: 100%; padding: 8px 10px; border: 1px solid #dcdfe6; border-radius: 6px; box-sizing: border-box; }
        .btn { padding: 10px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; }
        .btn-primary { background: #409eff; color: #fff; }
        .btn-danger { background: #f56c6c; color: #fff; }
        .btn-plain { background: #ebeef5; color: #606266; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 10px; border-bottom: 1px solid #eee; text-align: left; }
        th { background: #f2f6fc; }
        .tag { padding: 4px 8px; border-radius: 4px; font-size: 12px; color: #fff; }
        .tag-wait { background: #e6a23c; }
        .tag-cancel { background: #909399; }
        .tag-done { background: #67c23a; }
        .tag-ing { background: #409eff; }
        .tag-stop { background: #f56c6c; }
        .stats { display: flex; gap: 12px; flex-wrap: wrap; }
        .stat-item { padding: 12px; border-radius: 8px; background: #ecf5ff; color: #409eff; min-width: 160px; }
        .flash { padding: 10px; border-radius: 6px; margin-bottom: 8px; }
        .flash-success { background: #f0f9eb; color: #67c23a; }
        .flash-error { background: #fef0f0; color: #f56c6c; }
        .flash-info { background: #ecf5ff; color: #409eff; }
    </style>
</head>
<body>
<div class="layout">
    <div class="card" style="display:flex; justify-content:space-between; align-items:center;">
        <div>
            <h1>挂号管理</h1>
            <p style="color:#666;">新患者挂号 / 老患者快捷挂号 / 今日挂号列表 / 统计 / 排班管理</p>
        </div>
        <div>
            <a href="/patient_home" style="margin-right:10px; color:#409eff;">患者端</a>
            <a href="/doctor_dashboard" style="margin-right:10px; color:#409eff;">医生端</a>
            <a href="/patients" style="margin-right:10px; color:#409eff;">患者档案</a>
            <a href="/cashier" style="margin-right:10px; color:#409eff;">收银台</a>
            <a href="/logout" style="color:#f56c6c;">退出</a>
        </div>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for cat, msg in messages %}
                <div class="flash flash-{{cat}}">{{ msg }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <div class="flex">
        <div class="card" style="flex:1;">
            <h3>H1. 新患者挂号</h3>
            <form method="POST" action="/registration/new">
                <label>姓名</label>
                <input name="name" required placeholder="请输入姓名">

                <label>性别</label>
                <select name="gender" required>
                    <option value="男">男</option>
                    <option value="女">女</option>
                </select>

                <label>年龄</label>
                <input name="age" type="number" min="0" required>

                <label>手机号</label>
                <input name="phone" required>

                <label>过敏史</label>
                <input name="allergy" placeholder="可选">

                <div class="flex">
                    <div style="flex:1;">
                        <label>科室</label>
                        <select name="dept_id" id="dept_select_new" required onchange="filterDoctors('dept_select_new','doctor_select_new')">
                            <option value="">请选择科室</option>
                            {% for dept in departments %}
                            <option value="{{ dept.dept_id }}">{{ dept.dept_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div style="flex:1;">
                        <label>医生</label>
                        <select name="doctor_id" id="doctor_select_new" required>
                            <option value="">先选科室</option>
                            {% for doc in doctors %}
                            <option value="{{ doc.doctor_id }}" data-dept="{{ doc.dept_id }}">{{ doc.name }}（{{ doc.title }}）</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="flex">
                    <div style="flex:1;">
                        <label>就诊日期</label>
                        <input type="date" name="visit_date" required value="{{ selected_date }}">
                    </div>
                    <div style="flex:1;">
                        <label>班次</label>
                        <select name="shift" required>
                            <option value="上午">上午</option>
                            <option value="下午">下午</option>
                            <option value="夜间">夜间</option>
                        </select>
                    </div>
                </div>

                <p style="color:#999; font-size:12px;">病历号将在提交后自动生成，初始密码默认为 123456。</p>
                <button class="btn btn-primary" type="submit">提交挂号</button>
            </form>
        </div>

        <div class="card" style="flex:1;">
            <h3>H2. 老患者快速挂号</h3>
            <form method="POST" action="/registration/quick">
                <label>病历号 / 姓名</label>
                <input name="keyword" required placeholder="输入病历号或姓名查询">

                <div class="flex">
                    <div style="flex:1;">
                        <label>科室</label>
                        <select name="dept_id" id="dept_select_quick" required onchange="filterDoctors('dept_select_quick','doctor_select_quick')">
                            <option value="">请选择科室</option>
                            {% for dept in departments %}
                            <option value="{{ dept.dept_id }}">{{ dept.dept_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div style="flex:1;">
                        <label>医生</label>
                        <select name="doctor_id" id="doctor_select_quick" required>
                            <option value="">先选科室</option>
                            {% for doc in doctors %}
                            <option value="{{ doc.doctor_id }}" data-dept="{{ doc.dept_id }}">{{ doc.name }}（{{ doc.title }}）</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="flex">
                    <div style="flex:1;">
                        <label>就诊日期</label>
                        <input type="date" name="visit_date" required value="{{ selected_date }}">
                    </div>
                    <div style="flex:1;">
                        <label>班次</label>
                        <select name="shift" required>
                            <option value="上午">上午</option>
                            <option value="下午">下午</option>
                            <option value="夜间">夜间</option>
                        </select>
                    </div>
                </div>
                <button class="btn btn-primary" type="submit">快速挂号</button>
            </form>
        </div>
    </div>

    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3>H3. 今日挂号列表</h3>
            <form method="GET" action="/registration/manage">
                <input type="date" name="date" value="{{ selected_date }}" onchange="this.form.submit()">
            </form>
        </div>
        <table>
            <thead>
            <tr>
                <th>排队号</th><th>患者</th><th>病历号</th><th>科室/医生</th><th>班次</th><th>状态</th><th>费用</th><th>操作</th>
            </tr>
            </thead>
            <tbody>
            {% for r in today_regs %}
                <tr>
                    <td style="font-weight:bold;">{{ r.queue_num }}</td>
                    <td>{{ r.patient_name }}</td>
                    <td>{{ r.medical_record_no }}</td>
                    <td>{{ r.dept_name }} / {{ r.doctor_name }}</td>
                    <td>{{ r.shift }}</td>
                    <td>
                        {% if r.visit_status == '未就诊' %}
                            <span class="tag tag-wait">待就诊</span>
                        {% elif r.visit_status == '就诊中' %}
                            <span class="tag tag-ing">就诊中</span>
                        {% elif r.visit_status == '已就诊' %}
                            <span class="tag tag-done">已完成</span>
                        {% else %}
                            <span class="tag tag-cancel">已取消</span>
                        {% endif %}
                    </td>
                    <td>{{ r.fee_status }}</td>
                    <td>
                        {% if r.visit_status != '已取消' %}
                            <a class="btn btn-danger" style="padding:6px 10px;" href="/registration/cancel/{{ r.reg_id }}">退号</a>
                        {% else %}
                            <a class="btn btn-plain" style="padding:6px 10px;" href="/registration/restore/{{ r.reg_id }}">恢复</a>
                        {% endif %}
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="card">
        <h3>H4. 挂号统计</h3>
        <div class="stats">
            <div class="stat-item">今日挂号：{{ totals.total_cnt or 0 }} 人次</div>
            <div class="stat-item">挂号费合计：￥{{ totals.total_fee or 0 }}</div>
        </div>
        <table style="margin-top:10px;">
            <thead><tr><th>科室</th><th>数量</th></tr></thead>
            <tbody>
            {% for d in dept_stats %}
                <tr><td>{{ d.dept_name }}</td><td>{{ d.cnt }}</td></tr>
            {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="card">
        <h3>H5. 医生排班管理</h3>
        <form method="POST" action="/schedule/save" class="flex">
            <div style="flex:1;">
                <label>医生</label>
                <select name="doctor_id" required>
                    {% for doc in doctors %}
                    <option value="{{ doc.doctor_id }}">{{ doc.name }}（{{ doc.dept_name }}）</option>
                    {% endfor %}
                </select>
            </div>
            <div style="width:160px;">
                <label>日期</label>
                <input type="date" name="schedule_date" required value="{{ selected_date }}">
            </div>
            <div style="width:120px;">
                <label>班次</label>
                <select name="shift">
                    <option value="上午">上午</option>
                    <option value="下午">下午</option>
                    <option value="夜间">夜间</option>
                </select>
            </div>
            <div style="width:140px;">
                <label>号源数</label>
                <input type="number" name="max_slots" min="1" value="20" required>
            </div>
            <div style="width:140px;">
                <label>状态</label>
                <select name="status">
                    <option value="可用">可用</option>
                    <option value="停诊">停诊</option>
                </select>
            </div>
            <div style="display:flex; align-items:flex-end;">
                <button class="btn btn-primary" type="submit">保存排班</button>
            </div>
        </form>

        <table style="margin-top:12px;">
            <thead><tr><th>日期</th><th>班次</th><th>医生</th><th>科室</th><th>号源</th><th>状态</th><th>操作</th></tr></thead>
            <tbody>
            {% for s in schedules %}
                <tr>
                    <td>{{ s.schedule_date }}</td>
                    <td>{{ s.shift }}</td>
                    <td>{{ s.doctor_name }}</td>
                    <td>{{ s.dept_name }}</td>
                    <td>{{ s.booked_slots }}/{{ s.max_slots }}</td>
                    <td>
                        {% if s.status == '停诊' %}
                            <span class="tag tag-stop">停诊</span>
                        {% else %}
                            <span class="tag tag-ing">可用</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if s.status == '停诊' %}
                            <a class="btn btn-primary" style="padding:6px 10px;" href="/schedule/status/{{ s.schedule_id }}/可用">恢复</a>
                        {% else %}
                            <a class="btn btn-danger" style="padding:6px 10px;" href="/schedule/status/{{ s.schedule_id }}/停诊">停诊</a>
                        {% endif %}
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
    function filterDoctors(deptSelectId, docSelectId) {
        var dept = document.getElementById(deptSelectId).value;
        var docSel = document.getElementById(docSelectId);
        var options = docSel.querySelectorAll('option');
        options.forEach(function(opt, idx) {
            if (idx === 0) return; // keep placeholder
            opt.style.display = (dept === "" || opt.getAttribute('data-dept') === dept) ? 'block' : 'none';
        });
        docSel.value = "";
    }
</script>
</body>
</html>
