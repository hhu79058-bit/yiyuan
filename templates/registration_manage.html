{% extends "base.html" %}
{% block title %}挂号管理 - 诊疗通{% endblock %}

{% block extra_head %}
    <style>
        .stat-row{display:flex;gap:12px;flex-wrap:wrap;margin-top:10px}
        .stat{border:1px solid rgba(47,125,246,.2);background:rgba(47,125,246,.06);border-radius:14px;padding:12px 14px;min-width:220px}
        .stat .v{font-size:22px;font-weight:900;margin-top:6px}
        .slot-note{font-size:12px;color:var(--muted)}
    </style>
    <script>
        function filterDoctors(deptSelectId, docSelectId) {
            var dept = document.getElementById(deptSelectId).value;
            var docSel = document.getElementById(docSelectId);
            var options = docSel.querySelectorAll('option');
            options.forEach(function(opt, idx) {
                if (idx === 0) return;
                opt.style.display = (dept === "" || opt.getAttribute('data-dept') === dept) ? 'block' : 'none';
            });
            docSel.value = "";
        }
    </script>
{% endblock %}

{% block content %}
    <div class="card">
        <div class="page-title">
            <div>
                <h2>挂号管理</h2>
                <div class="subtitle">新/老患者挂号、当日列表、统计与排班</div>
            </div>
            <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end;">
                <form method="GET" action="{{ url_for('registration.registration_manage') }}" style="display:flex; gap:10px; align-items:center;">
                    <span class="muted">日期</span>
                    <input type="date" name="date" value="{{ selected_date }}">
                    <button class="btn btn--ghost btn--sm" type="submit">切换</button>
                </form>
            </div>
        </div>

        <div class="subnav" style="margin-top:12px;">
            <a href="#sec-register" class="is-active">挂号录入</a>
            <a href="#sec-list">当日列表</a>
            <a href="#sec-stats">挂号统计</a>
            <a href="#sec-schedule">排班管理</a>
        </div>
    </div>

    <section id="sec-register" class="card section">
        <div class="section__head">
            <div>
                <h3>挂号录入</h3>
                <div class="subtitle">新患者建档挂号 / 老患者快速挂号</div>
            </div>
        </div>

        <div class="grid grid-2">
            <div>
                <div class="section__head">
                    <div>
                        <h3>新患者挂号</h3>
                        <div class="subtitle">自动生成病历号，默认密码 <span class="mono">123456</span></div>
                    </div>
                </div>
                <form method="POST" action="{{ url_for('registration.registration_new_patient') }}">
                    <div class="form-row form-row-2">
                        <div>
                            <label>姓名</label>
                            <input name="name" required placeholder="请输入姓名">
                        </div>
                        <div>
                            <label>手机号</label>
                            <input name="phone" required>
                        </div>
                    </div>

                    <div class="form-row form-row-3">
                        <div>
                            <label>性别</label>
                            <select name="gender" required>
                                <option value="男">男</option>
                                <option value="女">女</option>
                            </select>
                        </div>
                        <div>
                            <label>年龄</label>
                            <input name="age" type="number" min="0" required>
                        </div>
                        <div>
                            <label>过敏史</label>
                            <input name="allergy" placeholder="可选">
                        </div>
                    </div>

                    <div class="form-row form-row-2">
                        <div>
                            <label>科室</label>
                            <select name="dept_id" id="dept_select_new" required onchange="filterDoctors('dept_select_new','doctor_select_new')">
                                <option value="">请选择科室</option>
                                {% for dept in departments %}
                                    <option value="{{ dept.dept_id }}">{{ dept.dept_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label>医生</label>
                            <select name="doctor_id" id="doctor_select_new" required>
                                <option value="">先选科室</option>
                                {% for doc in doctors %}
                                    <option value="{{ doc.doctor_id }}" data-dept="{{ doc.dept_id }}">{{ doc.name }}（{{ doc.title }}）</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <div class="form-row form-row-2">
                        <div>
                            <label>就诊日期</label>
                            <input type="date" name="visit_date" required value="{{ selected_date }}">
                        </div>
                        <div>
                            <label>班次</label>
                            <select name="shift" required>
                                <option value="上午">上午</option>
                                <option value="下午">下午</option>
                                <option value="夜间">夜间</option>
                                <option value="全天">全天</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row form-row-2">
                        <div>
                            <label>时间段</label>
                            <select name="time_slot" required>
                                {% for slot in time_slots %}
                                    <option value="{{ slot }}">{{ slot }}</option>
                                {% endfor %}
                            </select>
                            <div class="slot-note">按小时精准挂号</div>
                        </div>
                    </div>

                    <div style="margin-top:12px;">
                        <button class="btn btn--primary" type="submit">提交挂号</button>
                    </div>
                </form>
            </div>

            <div>
                <div class="section__head">
                    <div>
                        <h3>老患者快速挂号</h3>
                        <div class="subtitle">输入病历号或姓名快速检索</div>
                    </div>
                </div>
                <form method="POST" action="{{ url_for('registration.registration_quick') }}">
                    <label>病历号 / 姓名</label>
                    <input name="keyword" required placeholder="输入病历号或姓名">

                    <div class="form-row form-row-2">
                        <div>
                            <label>科室</label>
                            <select name="dept_id" id="dept_select_quick" required onchange="filterDoctors('dept_select_quick','doctor_select_quick')">
                                <option value="">请选择科室</option>
                                {% for dept in departments %}
                                    <option value="{{ dept.dept_id }}">{{ dept.dept_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label>医生</label>
                            <select name="doctor_id" id="doctor_select_quick" required>
                                <option value="">先选科室</option>
                                {% for doc in doctors %}
                                    <option value="{{ doc.doctor_id }}" data-dept="{{ doc.dept_id }}">{{ doc.name }}（{{ doc.title }}）</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <div class="form-row form-row-2">
                        <div>
                            <label>就诊日期</label>
                            <input type="date" name="visit_date" required value="{{ selected_date }}">
                        </div>
                        <div>
                            <label>班次</label>
                            <select name="shift" required>
                                <option value="上午">上午</option>
                                <option value="下午">下午</option>
                                <option value="夜间">夜间</option>
                                <option value="全天">全天</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row form-row-2">
                        <div>
                            <label>时间段</label>
                            <select name="time_slot" required>
                                {% for slot in time_slots %}
                                    <option value="{{ slot }}">{{ slot }}</option>
                                {% endfor %}
                            </select>
                            <div class="slot-note">按小时精准挂号</div>
                        </div>
                    </div>

                    <div style="margin-top:12px;">
                        <button class="btn btn--primary" type="submit">快速挂号</button>
                    </div>
                </form>
            </div>
        </div>
    </section>

    <section id="sec-list" class="card section">
        <div class="section__head">
            <div>
                <h3>当日挂号列表</h3>
                <div class="subtitle">可退号/恢复，支持按状态与支付查看</div>
            </div>
        </div>

        <div class="table-wrap">
            <table class="table">
                <thead>
                <tr>
                    <th>排队号</th>
                    <th>患者</th>
                    <th>病历号</th>
                    <th>科室/医生</th>
                    <th>时间段</th>
                    <th>状态</th>
                    <th>支付</th>
                    <th>操作</th>
                </tr>
                </thead>
                <tbody>
                {% for r in today_regs %}
                    <tr>
                        <td class="mono" style="font-weight:900;">{{ r.queue_num }}</td>
                        <td>{{ r.patient_name }}</td>
                        <td class="mono">{{ r.medical_record_no|default('—', true) }}</td>
                        <td>{{ r.dept_name }} / {{ r.doctor_name }}</td>
                        <td>{{ r.visit_date|default('—', true) }} {{ r.time_slot|default('—', true) }}</td>
                        <td>
                            {% if r.visit_status == '未就诊' %}
                                <span class="badge badge--warning">未就诊</span>
                            {% elif r.visit_status == '就诊中' %}
                                <span class="badge badge--info">就诊中</span>
                            {% elif r.visit_status == '已就诊' %}
                                <span class="badge badge--success">已完成</span>
                            {% else %}
                                <span class="badge badge--muted">已取消</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if r.fee_status == '已支付' %}
                                <span class="badge badge--success">已支付</span>
                            {% else %}
                                <span class="badge badge--warning">未支付</span>
                            {% endif %}
                        </td>
                        <td style="white-space:nowrap;">
                            {% if r.visit_status != '已取消' %}
                                <a class="btn btn--danger btn--sm" href="{{ url_for('registration.registration_cancel', reg_id=r.reg_id) }}" onclick="return confirm('确认退号？');">退号</a>
                            {% else %}
                                <a class="btn btn--ghost btn--sm" href="{{ url_for('registration.registration_restore', reg_id=r.reg_id) }}">恢复</a>
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
                {% if not today_regs %}
                    <tr><td colspan="8" class="muted">暂无挂号数据</td></tr>
                {% endif %}
                </tbody>
            </table>
        </div>
    </section>

    <section id="sec-stats" class="card section">
        <div class="section__head">
            <div>
                <h3>挂号统计</h3>
                <div class="subtitle">当日汇总</div>
            </div>
        </div>
        <div class="stat-row">
            <div class="stat">
            <div class="muted">今日挂号</div>
            <div class="v">{{ totals.total_cnt or 0 }} 人次</div>
        </div>
        <div class="stat">
            <div class="muted">挂号费合计</div>
                <div class="v">￥{{ totals.total_fee or 0 }}</div>
            </div>
        </div>

        <div class="table-wrap" style="margin-top:12px;">
            <table class="table">
                <thead><tr><th>科室</th><th>数量</th></tr></thead>
                <tbody>
                {% for d in dept_stats %}
                    <tr><td>{{ d.dept_name }}</td><td>{{ d.cnt }}</td></tr>
                {% endfor %}
                {% if not dept_stats %}
                    <tr><td colspan="2" class="muted">暂无数据</td></tr>
                {% endif %}
                </tbody>
            </table>
        </div>

        <div class="table-wrap" style="margin-top:16px;">
            <div class="subtitle" style="margin-bottom:6px;">科室分类与医生数量</div>
            <table class="table">
                <thead><tr><th>科室</th><th>医生数量</th></tr></thead>
                <tbody>
                {% for d in dept_doctors %}
                    <tr><td>{{ d.dept_name }}</td><td>{{ d.doctor_count }}</td></tr>
                {% endfor %}
                {% if not dept_doctors %}
                    <tr><td colspan="2" class="muted">暂无数据</td></tr>
                {% endif %}
                </tbody>
            </table>
        </div>
    </section>

    <section id="sec-schedule" class="card section">
        <div class="section__head">
            <div>
                <h3>医生排班管理</h3>
                <div class="subtitle">设置号源与停诊</div>
            </div>
        </div>

        <form method="POST" action="{{ url_for('registration.schedule_save') }}">
            <div class="form-row form-row-3">
                <div>
                    <label>医生</label>
                    <select name="doctor_id" required>
                        {% for doc in doctors %}
                            <option value="{{ doc.doctor_id }}">{{ doc.name }}（{{ doc.dept_name }}）</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label>日期</label>
                    <input type="date" name="schedule_date" required value="{{ selected_date }}">
                </div>
                <div>
                    <label>班次</label>
                    <select name="shift">
                        <option value="上午">上午</option>
                        <option value="下午">下午</option>
                        <option value="夜间">夜间</option>
                        <option value="全天">全天</option>
                    </select>
                </div>
            </div>

            <div class="form-row form-row-3">
                <div>
                    <label>时间段</label>
                    <select name="time_slot">
                        {% for slot in time_slots %}
                            <option value="{{ slot }}">{{ slot }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label>号源数</label>
                    <input type="number" name="max_slots" min="1" value="20" required>
                </div>
                <div>
                    <label>状态</label>
                    <select name="status">
                        <option value="可用">可用</option>
                        <option value="停诊">停诊</option>
                    </select>
                </div>
            </div>

            <div style="margin-top:12px;">
                <button class="btn btn--primary" type="submit">保存排班</button>
            </div>
        </form>

        <div class="table-wrap" style="margin-top:14px;">
            <table class="table">
                <thead>
                <tr><th>日期</th><th>班次</th><th>时间段</th><th>医生</th><th>科室</th><th>号源</th><th>状态</th><th>操作</th></tr>
                </thead>
                <tbody>
                {% for s in schedules %}
                    <tr>
                        <td>{{ s.schedule_date|default('—', true) }}</td>
                        <td>{{ s.shift }}</td>
                        <td>{{ s.time_slot|default('—', true) }}</td>
                        <td>{{ s.doctor_name }}</td>
                        <td>{{ s.dept_name }}</td>
                        <td>{{ s.booked_slots }}/{{ s.max_slots }}</td>
                        <td>
                            {% if s.status == '停诊' %}
                                <span class="badge badge--danger">停诊</span>
                            {% else %}
                                <span class="badge badge--info">可用</span>
                            {% endif %}
                        </td>
                        <td style="white-space:nowrap;">
                            {% if s.status == '停诊' %}
                                <a class="btn btn--primary btn--sm" href="{{ url_for('registration.schedule_status', schedule_id=s.schedule_id, new_status='可用') }}">恢复</a>
                            {% else %}
                                <a class="btn btn--danger btn--sm" href="{{ url_for('registration.schedule_status', schedule_id=s.schedule_id, new_status='停诊') }}" onclick="return confirm('确认停诊？');">停诊</a>
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
                {% if not schedules %}
                    <tr><td colspan="7" class="muted">暂无排班数据</td></tr>
                {% endif %}
                </tbody>
            </table>
        </div>
    </section>

    <script>
        (function () {
            var items = document.querySelectorAll('.subnav a');
            function setActive(hash) {
                items.forEach(function (a) {
                    a.classList.toggle('is-active', a.getAttribute('href') === hash);
                });
            }
            items.forEach(function (a) {
                a.addEventListener('click', function () {
                    setActive(a.getAttribute('href'));
                });
            });
        })();
    </script>
{% endblock %}
