{% extends "base.html" %}
{% block title %}收银台 - 诊疗通{% endblock %}

{% block content %}
    <div class="card">
        <div class="page-title">
            <div>
                <h2>收银台</h2>
                <div class="subtitle">展示费用明细并变更支付状态（医生端）</div>
            </div>
        </div>
    </div>

    <div class="card">
        <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
            <form method="GET" action="{{ url_for('cashier.cashier_page') }}" style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                <span class="muted">日期</span>
                <input type="date" name="date" value="{{ selected_date }}">
                <span class="muted">状态</span>
                <select name="status">
                    <option value="all" {% if status_filter=='all' %}selected{% endif %}>全部</option>
                    <option value="unpaid" {% if status_filter=='unpaid' %}selected{% endif %}>未支付</option>
                    <option value="paid" {% if status_filter=='paid' %}selected{% endif %}>已支付</option>
                </select>
                <button class="btn btn--ghost btn--sm" type="submit">筛选</button>
            </form>
            <div style="margin-left:auto;">
                <span class="badge badge--info">合计 {{ totals.count }} 笔</span>
                <span class="badge badge--success" style="margin-left:8px;">￥{{ '%.2f' % totals.amount }}</span>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="table-wrap">
            <table class="table">
                <thead>
                <tr>
                    <th>患者</th>
                    <th>病历号</th>
                    <th>医生</th>
                    <th>日期/班次</th>
                    <th>挂号费</th>
                    <th>检查费</th>
                    <th>药费</th>
                    <th>应付合计</th>
                    <th>状态</th>
                    <th>操作</th>
                </tr>
                </thead>
                <tbody>
                {% for r in rows %}
                    <tr>
                        <td>{{ r.patient_name }}</td>
                        <td class="mono">{{ r.medical_record_no|default('—', true) }}</td>
                        <td>{{ r.doctor_name }}</td>
                        <td>{{ r.visit_date|default('—', true) }} {{ r.shift|default('—', true) }}</td>
                        <td>￥{{ '%.2f' % r.reg_fee }}</td>
                        <td>￥{{ '%.2f' % r.check_fee }}</td>
                        <td>￥{{ '%.2f' % r.med_fee }}</td>
                        <td style="font-weight:900;">￥{{ '%.2f' % r.total_fee }}</td>
                        <td>
                            {% if r.visit_status == '已取消' %}
                                <span class="badge badge--muted">已取消</span>
                            {% elif r.fee_status == '已支付' %}
                                <span class="badge badge--success">已支付</span>
                            {% else %}
                                <span class="badge badge--warning">未支付</span>
                            {% endif %}
                        </td>
                        <td style="white-space:nowrap;">
                            {% if r.visit_status == '已取消' %}
                                <span class="muted">—</span>
                            {% elif r.fee_status != '已支付' %}
                                <form method="POST" action="{{ url_for('cashier.cashier_pay', reg_id=r.reg_id) }}" style="margin:0;">
                                    <button class="btn btn--primary btn--sm" type="submit" onclick="return confirm('确认已收款？');">标记已支付</button>
                                </form>
                            {% else %}
                                <span class="muted">—</span>
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
                {% if not rows %}
                    <tr><td colspan="10" class="muted">暂无数据</td></tr>
                {% endif %}
                </tbody>
            </table>
        </div>
    </div>
{% endblock %}
