{% extends "base.html" %}
{% block title %}药房管理 - 诊疗通{% endblock %}

{% block content %}
    <div class="card">
        <div class="page-title">
            <div>
                <h2>药房管理</h2>
                <div class="subtitle">药品进货/补货/调价/下架，以及已支付待发药清单</div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="page-title">
            <div>
                <h2>新增药品（进货）</h2>
                <div class="subtitle">新增药品条目并设置初始库存</div>
            </div>
        </div>
        <form method="POST" action="{{ url_for('pharmacy.pharmacy_add') }}">
            <div class="form-row form-row-3">
                <div style="grid-column: span 2;">
                    <label>药品名称</label>
                    <input name="med_name" required placeholder="请输入药品名称">
                </div>
                <div>
                    <label>单价</label>
                    <input name="price" type="number" step="0.01" min="0" required>
                </div>
                <div>
                    <label>库存</label>
                    <input name="stock" type="number" min="0" required>
                </div>
            </div>
            <div style="margin-top:12px;">
                <button class="btn btn--primary" type="submit">添加</button>
            </div>
        </form>
    </div>

    <div class="card">
        <div class="page-title">
            <div>
                <h2>药品列表</h2>
                <div class="subtitle">补货 / 调价 / 下架</div>
            </div>
        </div>
        <div class="table-wrap">
            <table class="table">
                <thead>
                <tr><th>ID</th><th>名称</th><th>单价</th><th>库存</th><th>操作</th></tr>
                </thead>
                <tbody>
                {% for m in medicines %}
                    <tr>
                        <form method="POST" action="{{ url_for('pharmacy.pharmacy_update') }}">
                            <td class="mono">{{ m.med_id }}<input type="hidden" name="med_id" value="{{ m.med_id }}"></td>
                            <td>{{ m.med_name }}</td>
                            <td><input type="number" step="0.01" min="0" name="price" value="{{ m.price }}"></td>
                            <td><input type="number" min="0" name="stock" value="{{ m.stock }}"></td>
                            <td style="white-space:nowrap;">
                                <button class="btn btn--primary btn--sm" type="submit">保存</button>
                                <a class="btn btn--danger btn--sm"
                                   href="{{ url_for('pharmacy.pharmacy_delete', med_id=m.med_id) }}"
                                   onclick="return confirm('确认下架该药品？');">下架</a>
                            </td>
                        </form>
                    </tr>
                {% endfor %}
                {% if not medicines %}
                    <tr><td colspan="5" class="muted">暂无药品数据</td></tr>
                {% endif %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="card">
        <div class="page-title">
            <div>
                <h2>发药管理</h2>
                <div class="subtitle">仅显示已支付且未发药的处方药品项</div>
            </div>
        </div>
        <div class="table-wrap">
            <table class="table">
                <thead>
                <tr>
                    <th>患者</th>
                    <th>病历号</th>
                    <th>医生</th>
                    <th>日期/班次</th>
                    <th>药品</th>
                    <th>数量</th>
                    <th>金额</th>
                    <th>操作</th>
                </tr>
                </thead>
                <tbody>
                {% for it in pending_items %}
                    <tr>
                        <td>{{ it.patient_name }}</td>
                        <td class="mono">{{ it.medical_record_no|default('—', true) }}</td>
                        <td>{{ it.doctor_name }}</td>
                        <td>{{ it.visit_date|default('—', true) }} {{ it.shift|default('—', true) }}</td>
                        <td>{{ it.med_name }}</td>
                        <td>{{ it.total_quantity }}</td>
                        <td>￥{{ '%.2f' % it.total_amount }}</td>
                        <td style="white-space:nowrap;">
                            <form method="POST" action="{{ url_for('pharmacy.pharmacy_dispense') }}" style="margin:0;">
                                <input type="hidden" name="reg_id" value="{{ it.reg_id }}">
                                <input type="hidden" name="med_id" value="{{ it.med_id }}">
                                <button class="btn btn--primary btn--sm" type="submit" onclick="return confirm('确认发药并扣减库存？');">确认发药</button>
                            </form>
                        </td>
                    </tr>
                {% endfor %}
                {% if not pending_items %}
                    <tr><td colspan="8" class="muted">暂无待发药处方</td></tr>
                {% endif %}
                </tbody>
            </table>
        </div>
    </div>
{% endblock %}
